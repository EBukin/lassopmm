<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How it works in steps â€¢ lassopmm</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How it works in steps">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lassopmm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/how_it_works.html">How it works in steps</a>
    </li>
    <li>
      <a href="../articles/lassopmm_shiny_app.html">Shiny app with lassopmm functionality</a>
    </li>
    <li>
      <a href="../articles/mice_vs_mi.html">Multiple imputation statistics in STATA and R</a>
    </li>
    <li>
      <a href="../articles/r_script_lassopmm.html">R script for lassopmm</a>
    </li>
    <li>
      <a href="../articles/r_vs_stata_lassopmm.html">R versus STATA 'lassopmm'</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>How it works in steps</h1>
            
      
      
      <div class="hidden name"><code>how_it_works.Rmd</code></div>

    </div>

    
    
<p>Here we break into the parts how the imputation process is built in this package.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">#&gt; Attaching package: 'dplyr'</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">#&gt; The following objects are masked from 'package:stats':</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">#&gt;     filter, lag</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#&gt; The following objects are masked from 'package:base':</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#&gt;     intersect, setdiff, setequal, union</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(purrr)</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lassopmm)</a></code></pre></div>
<div id="step-1--bootstrapping" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1--bootstrapping" class="anchor"></a>Step 1. Bootstrapping</h2>
<p>To re sample data in a reproducible way, we create bootstrapping vectors. These are then used for sub sampling input data. It all comes to a simple <code>sample</code> function form base R, which re-sample a vector of indexes with the repetitions. It is wrapped around the two functions.</p>
<p><code><a href="../reference/get_bootstrap_permutation.html">get_bootstrap_permutation()</a></code></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">get_bootstrap_permutation</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">#&gt; function (.data, n_boot = NULL) </span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">#&gt;     if (n_boot == 0) {</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">#&gt;         purrr::map(1, function(i) {</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#&gt;             purrr::map(.data, function(y) {</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">#&gt;                 y[[1]]</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">#&gt;             }) %&gt;% unlist()</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co">#&gt;         }) %&gt;% return()</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="co">#&gt;     unique_clusters &lt;- unique(.data$.cluster)</span></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co">#&gt;     purrr::map(1:n_boot, .f = function(z) {</span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="co">#&gt;         if (length(unique_clusters) &gt; 1) {</span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="co">#&gt;             random_cluster &lt;- unique_clusters %&gt;% sample_vector()</span></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="co">#&gt;         }</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="co">#&gt;         else {</span></a>
<a class="sourceLine" id="cb2-17" title="17"><span class="co">#&gt;             random_cluster &lt;- unique_clusters</span></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="co">#&gt;         }</span></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="co">#&gt;         random_cluster %&gt;% purrr::map(.f = function(x) {</span></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="co">#&gt;             one_cluster &lt;- dplyr::filter(.data, .cluster == x) %&gt;% </span></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="co">#&gt;                 dplyr::select(.strata, ids)</span></a>
<a class="sourceLine" id="cb2-22" title="22"><span class="co">#&gt;             unique_stratas &lt;- unique(one_cluster$.strata)</span></a>
<a class="sourceLine" id="cb2-23" title="23"><span class="co">#&gt;             unique_stratas %&gt;% purrr::map(.f = function(y) {</span></a>
<a class="sourceLine" id="cb2-24" title="24"><span class="co">#&gt;                 dplyr::filter(one_cluster, .strata == y) %&gt;% </span></a>
<a class="sourceLine" id="cb2-25" title="25"><span class="co">#&gt;                   dplyr::pull(ids) %&gt;% sample_vector()</span></a>
<a class="sourceLine" id="cb2-26" title="26"><span class="co">#&gt;             })</span></a>
<a class="sourceLine" id="cb2-27" title="27"><span class="co">#&gt;         }) %&gt;% unlist()</span></a>
<a class="sourceLine" id="cb2-28" title="28"><span class="co">#&gt;     })</span></a>
<a class="sourceLine" id="cb2-29" title="29"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb2-30" title="30"><span class="co">#&gt; &lt;bytecode: 0x0000000018d61450&gt;</span></a>
<a class="sourceLine" id="cb2-31" title="31"><span class="co">#&gt; &lt;environment: namespace:lassopmm&gt;</span></a></code></pre></div>
<p><code><a href="../reference/sample_vector.html">sample_vector()</a></code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">sample_vector</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">#&gt; function (ids) </span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#&gt;     sample(ids, size = length(ids), replace = T)</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt; &lt;bytecode: 0x0000000018ef6870&gt;</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; &lt;environment: namespace:lassopmm&gt;</span></a></code></pre></div>
<p>As an example, let us create a data fame with two columns <code>id</code> and <code>group</code>. Column group is used for the group wise re-sampling and the column id is returned as an index of the new sample structure.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="../reference/sample_vector.html">sample_vector</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co">#&gt;  [1]  6  1 10  7  9  9  2  8  4  1</span></a>
<a class="sourceLine" id="cb4-3" title="3">df &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(<span class="dt">id =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>, <span class="dt">group =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sort">sort</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">10</span>)))</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">glimpse</span>(df)</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co">#&gt; Observations: 20</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; Variables: 2</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt; $ id    &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 1...</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#&gt; $ group &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="kw"><a href="../reference/get_bootstrap_permutation.html">get_bootstrap_permutation</a></span>(df, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#&gt; Warning: Unknown or uninitialised column: '.cluster'.</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="co">#&gt; NULL</span></a></code></pre></div>
<p>Using 0 as the number of permulation allows us to return dataset identical to the original source data. In such case, bootstrap function simply returns vector with the same index as the input one.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="../reference/get_bootstrap_permutation.html">get_bootstrap_permutation</a></span>(df, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">#&gt; Warning: Unknown or uninitialised column: '.cluster'.</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">#&gt; NULL</span></a></code></pre></div>
</div>
<div id="step-2--matching-the-nearest-observation" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2--matching-the-nearest-observation" class="anchor"></a>Step 2. Matching the nearest observation</h2>
<p>It happens also in two steps.</p>
<p><code><a href="../reference/find_one_near.html">find_one_near()</a></code> finds a nearest match of one observation from a vector of observations.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">find_one_near</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">#&gt; function (o, m, n_near = 5) </span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">#&gt;     null_names_m &lt;- is.null(names(m))</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="co">#&gt;     if (null_names_m) </span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#&gt;         m &lt;- stats::setNames(m, as.character(1:length(m)))</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt;     near_obs &lt;- names(sort(abs(m - o), na.last = TRUE, decreasing = F))[1:min(n_near, </span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#&gt;         length(m))]</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">#&gt;     match &lt;- sample(near_obs, size = 1, replace = FALSE)</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#&gt;     list(target_id = names(o), target_y_hat = o[[1]], source_id = if (null_names_m) NULL else match, </span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#&gt;         source_y_hat = m[[match]])</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#&gt; &lt;bytecode: 0x0000000018655a68&gt;</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">#&gt; &lt;environment: namespace:lassopmm&gt;</span></a></code></pre></div>
<p>It works as follows allowing to have named an unnamed vectors supplied into it.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw"><a href="../reference/find_one_near.html">find_one_near</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"a"</span> =<span class="st"> </span><span class="dv">10</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">8</span><span class="op">:</span><span class="dv">15</span>), <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co">#&gt; $target_id</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">#&gt; [1] "a"</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co">#&gt; $target_y_hat</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="co">#&gt; [1] 10</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="co">#&gt; $source_id</span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="co">#&gt; $source_y_hat</span></a>
<a class="sourceLine" id="cb7-12" title="12"><span class="co">#&gt; [1] 9</span></a></code></pre></div>
<p><code><a href="../reference/find_near.html">find_near()</a></code> wraps it for matching vector with the vector.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">find_near</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">#&gt; function (observ_vector, match_vector, n_near = 5) </span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">#&gt;     if (length(match_vector) &lt; n_near) {</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">#&gt;         warning("Number of the nearest observations for random selection is greater than the vector of alternatives.")</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">#&gt;     if (is.null(names(observ_vector))) {</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">#&gt;         purrr::map_dfr(observ_vector, ~find_one_near(o = .x, </span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">#&gt;             m = match_vector, n_near = n_near)) %&gt;% return()</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">#&gt;     else {</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">#&gt;         purrr::map2_dfr(observ_vector, names(observ_vector), </span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">#&gt;             ~find_one_near(o = setNames(.x, .y), m = match_vector, </span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">#&gt;                 n_near = n_near)) %&gt;% return()</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co">#&gt; &lt;bytecode: 0x0000000018bfead0&gt;</span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co">#&gt; &lt;environment: namespace:lassopmm&gt;</span></a></code></pre></div>
<p>Producing:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">obs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">5</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">as.character</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>))</a>
<a class="sourceLine" id="cb9-2" title="2">match_v &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">50</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">as.character</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">50</span>))</a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw"><a href="../reference/find_near.html">find_near</a></span>(obs, match_v, <span class="dt">n_near =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">#&gt; # A tibble: 5 x 4</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">#&gt;   target_id target_y_hat source_id source_y_hat</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;            &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">#&gt; 1 1               -1.34  6               -1.33 </span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">#&gt; 2 2               -0.706 26              -0.545</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co">#&gt; 3 3               -0.670 30              -0.645</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">#&gt; 4 4               -1.25  7               -1.04 </span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">#&gt; 5 5               -0.815 7               -1.04</span></a></code></pre></div>
</div>
<div id="step-3--estimating-matches" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3--estimating-matches" class="anchor"></a>Step 3. Estimating matches</h2>
<p>This is done with the <code><a href="../reference/estimate_matches.html">estimate_matches()</a></code> which accepts already re sampled data. Lets follow an example. We initialize the necessary data vectors X, Y, W-weights and XX1 - period 1 independent variables for predictions.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">XX &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(mtcars[, <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(mtcars) <span class="op">%in%</span><span class="st"> "hp"</span>])</a>
<a class="sourceLine" id="cb10-2" title="2">YY &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(mtcars[, <span class="st">"hp"</span>])</a>
<a class="sourceLine" id="cb10-3" title="3">WW &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(mtcars)), <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">nrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(mtcars))</a>
<a class="sourceLine" id="cb10-4" title="4">XX1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(mtcars[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(mtcars) <span class="op">%in%</span><span class="st"> "hp"</span>])</a></code></pre></div>
<p>Running simple estimation and returning the output is straightforward. We run it in the full - not reduced form to see all the possible outputs of the function.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">a &lt;-<span class="st"> </span><span class="kw"><a href="../reference/estimate_matches.html">estimate_matches</a></span>(<span class="dt">source_x_mat =</span> XX, </a>
<a class="sourceLine" id="cb11-2" title="2">                      <span class="dt">source_y_mat =</span> YY, </a>
<a class="sourceLine" id="cb11-3" title="3">                      <span class="dt">source_w_mat =</span> WW, </a>
<a class="sourceLine" id="cb11-4" title="4">                      <span class="dt">target_x_mat =</span> XX1, </a>
<a class="sourceLine" id="cb11-5" title="5">                      <span class="dt">reduced =</span> <span class="ot">FALSE</span>, </a>
<a class="sourceLine" id="cb11-6" title="6">                      <span class="dt">n_near =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb11-7" title="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(a, <span class="dt">max.level =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">#&gt; List of 9</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">#&gt;  $ source_x_mat: num [1:32, 1:10] 21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">#&gt;  $ source_w_mat: num [1:32, 1] 1 1 1 1 1 1 1 1 1 1 ...</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">#&gt;  $ source_y_mat: num [1:32, 1] 110 110 93 110 175 105 245 62 95 123 ...</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#&gt;  $ target_x_mat: num [1:10, 1:10] 21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">#&gt;  $ lambda_cv   :List of 10</span></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="co">#&gt;   ..- attr(*, "class")= chr "cv.glmnet"</span></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="co">#&gt;  $ fit         :List of 12</span></a>
<a class="sourceLine" id="cb11-18" title="18"><span class="co">#&gt;   ..- attr(*, "class")= chr [1:2] "elnet" "glmnet"</span></a>
<a class="sourceLine" id="cb11-19" title="19"><span class="co">#&gt;  $ source_y_hat: Named num [1:32] 156.4 152.7 77.6 114.5 176.8 ...</span></a>
<a class="sourceLine" id="cb11-20" title="20"><span class="co">#&gt;   ..- attr(*, "names")= chr [1:32] "Mazda RX4" "Mazda RX4 Wag" "Datsun 710" "Hornet 4 Drive" ...</span></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="co">#&gt;  $ target_y_hat: Named num [1:10] 156.4 152.7 77.6 114.5 176.8 ...</span></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="co">#&gt;   ..- attr(*, "names")= chr [1:10] "Mazda RX4" "Mazda RX4 Wag" "Datsun 710" "Hornet 4 Drive" ...</span></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="co">#&gt;  $ match       :Classes 'tbl_df', 'tbl' and 'data.frame':    10 obs. of  4 variables:</span></a></code></pre></div>
<p>to extract coefficients of the fited lasso regression, we use:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">a<span class="op">$</span>fit <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>()</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">#&gt; 11 x 1 sparse Matrix of class "dgCMatrix"</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co">#&gt;                      s0</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">#&gt; (Intercept) 148.1928176</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">#&gt; mpg          -0.1106935</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="co">#&gt; cyl           3.5699209</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">#&gt; disp          0.2339600</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="co">#&gt; drat          .        </span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="co">#&gt; wt            .        </span></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="co">#&gt; qsec         -6.5904714</span></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">#&gt; vs            .        </span></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="co">#&gt; am            .        </span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">#&gt; gear          .        </span></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co">#&gt; carb         15.0334872</span></a></code></pre></div>
<p>Same could be done with the bootstrapping. The only difference is that we have to supply to the function a sub sampled version of data (X, Y and W). We can do so using <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map</a></code> and split-apply-combine strategy.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">perm_example &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(YY), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(YY), <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb13-2" title="2">a_boot &lt;-</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="st">   </span>perm_example <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="st">   </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="op">~</span><span class="st"> </span>lassopmm<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/lassopmm/topics/estimate_matches">estimate_matches</a></span>(</a>
<a class="sourceLine" id="cb13-5" title="5">     <span class="dt">source_x_mat =</span> XX[.x, ],</a>
<a class="sourceLine" id="cb13-6" title="6">     <span class="dt">source_y_mat =</span> YY[.x, ],</a>
<a class="sourceLine" id="cb13-7" title="7">     <span class="dt">source_w_mat =</span> WW[.x, ], </a>
<a class="sourceLine" id="cb13-8" title="8">     <span class="dt">target_x_mat =</span> XX1,</a>
<a class="sourceLine" id="cb13-9" title="9">     <span class="dt">reduced =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb13-10" title="10">     <span class="dt">n_near =</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb13-11" title="11">   ))</a></code></pre></div>
<p>Here is an example of the possible outcomes of the bootstrapped analysis and how they could be tackled using <code>purrr</code> package:</p>
<ul>
<li>Exploring the structure:</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">a_boot <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(<span class="dt">max.level =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-3" title="3"><span class="co">#&gt; List of 3</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="co">#&gt;  $ :List of 9</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="co">#&gt;  $ :List of 9</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="co">#&gt;  $ :List of 9</span></a></code></pre></div>
<ul>
<li>Accessing fit of a specific bootstrap iteration</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">a_boot[[<span class="dv">3</span>]]<span class="op">$</span>fit</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co">#&gt; Call:  glmnet::glmnet(x = source_x_mat, y = source_y_mat, weights = source_w_mat,      alpha = 1, lambda = lambda_cv$lambda.min) </span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="co">#&gt;      Df  %Dev Lambda</span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="co">#&gt; [1,]  5 0.894  2.701</span></a></code></pre></div>
<ul>
<li>Doing the same with each single bootstrap iteration</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">a_boot <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map</span>(<span class="st">"fit"</span>)</a>
<a class="sourceLine" id="cb16-2" title="2"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="co">#&gt; Call:  glmnet::glmnet(x = source_x_mat, y = source_y_mat, weights = source_w_mat,      alpha = 1, lambda = lambda_cv$lambda.min) </span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="co">#&gt;      Df   %Dev Lambda</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="co">#&gt; [1,]  6 0.8881  1.958</span></a>
<a class="sourceLine" id="cb16-8" title="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-9" title="9"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb16-10" title="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="co">#&gt; Call:  glmnet::glmnet(x = source_x_mat, y = source_y_mat, weights = source_w_mat,      alpha = 1, lambda = lambda_cv$lambda.min) </span></a>
<a class="sourceLine" id="cb16-12" title="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-13" title="13"><span class="co">#&gt;      Df   %Dev Lambda</span></a>
<a class="sourceLine" id="cb16-14" title="14"><span class="co">#&gt; [1,]  5 0.8915   2.25</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-16" title="16"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb16-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-18" title="18"><span class="co">#&gt; Call:  glmnet::glmnet(x = source_x_mat, y = source_y_mat, weights = source_w_mat,      alpha = 1, lambda = lambda_cv$lambda.min) </span></a>
<a class="sourceLine" id="cb16-19" title="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-20" title="20"><span class="co">#&gt;      Df  %Dev Lambda</span></a>
<a class="sourceLine" id="cb16-21" title="21"><span class="co">#&gt; [1,]  5 0.894  2.701</span></a></code></pre></div>
<ul>
<li>Extracting coefficients from each single bootstrap iteration</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">a_boot <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st"> </span><span class="kw">map</span>(<span class="st">"fit"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st"> </span><span class="kw">map</span>(coefficients)</a>
<a class="sourceLine" id="cb17-4" title="4"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="co">#&gt; 11 x 1 sparse Matrix of class "dgCMatrix"</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="co">#&gt;                      s0</span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="co">#&gt; (Intercept) 307.5416502</span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">#&gt; mpg          -1.4027192</span></a>
<a class="sourceLine" id="cb17-9" title="9"><span class="co">#&gt; cyl           7.9415884</span></a>
<a class="sourceLine" id="cb17-10" title="10"><span class="co">#&gt; disp          0.1998169</span></a>
<a class="sourceLine" id="cb17-11" title="11"><span class="co">#&gt; drat          .        </span></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="co">#&gt; wt            .        </span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="co">#&gt; qsec        -13.7337542</span></a>
<a class="sourceLine" id="cb17-14" title="14"><span class="co">#&gt; vs           12.4414216</span></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="co">#&gt; am            .        </span></a>
<a class="sourceLine" id="cb17-16" title="16"><span class="co">#&gt; gear          .        </span></a>
<a class="sourceLine" id="cb17-17" title="17"><span class="co">#&gt; carb          1.9862503</span></a>
<a class="sourceLine" id="cb17-18" title="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb17-19" title="19"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb17-20" title="20"><span class="co">#&gt; 11 x 1 sparse Matrix of class "dgCMatrix"</span></a>
<a class="sourceLine" id="cb17-21" title="21"><span class="co">#&gt;                      s0</span></a>
<a class="sourceLine" id="cb17-22" title="22"><span class="co">#&gt; (Intercept) 288.9225533</span></a>
<a class="sourceLine" id="cb17-23" title="23"><span class="co">#&gt; mpg           .        </span></a>
<a class="sourceLine" id="cb17-24" title="24"><span class="co">#&gt; cyl           1.3730458</span></a>
<a class="sourceLine" id="cb17-25" title="25"><span class="co">#&gt; disp          0.2518685</span></a>
<a class="sourceLine" id="cb17-26" title="26"><span class="co">#&gt; drat          .        </span></a>
<a class="sourceLine" id="cb17-27" title="27"><span class="co">#&gt; wt            .        </span></a>
<a class="sourceLine" id="cb17-28" title="28"><span class="co">#&gt; qsec        -12.2688834</span></a>
<a class="sourceLine" id="cb17-29" title="29"><span class="co">#&gt; vs            .        </span></a>
<a class="sourceLine" id="cb17-30" title="30"><span class="co">#&gt; am          -11.8694289</span></a>
<a class="sourceLine" id="cb17-31" title="31"><span class="co">#&gt; gear          .        </span></a>
<a class="sourceLine" id="cb17-32" title="32"><span class="co">#&gt; carb          4.7967561</span></a>
<a class="sourceLine" id="cb17-33" title="33"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb17-34" title="34"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb17-35" title="35"><span class="co">#&gt; 11 x 1 sparse Matrix of class "dgCMatrix"</span></a>
<a class="sourceLine" id="cb17-36" title="36"><span class="co">#&gt;                     s0</span></a>
<a class="sourceLine" id="cb17-37" title="37"><span class="co">#&gt; (Intercept) 24.2035769</span></a>
<a class="sourceLine" id="cb17-38" title="38"><span class="co">#&gt; mpg          .        </span></a>
<a class="sourceLine" id="cb17-39" title="39"><span class="co">#&gt; cyl          5.6917653</span></a>
<a class="sourceLine" id="cb17-40" title="40"><span class="co">#&gt; disp         0.3094622</span></a>
<a class="sourceLine" id="cb17-41" title="41"><span class="co">#&gt; drat         .        </span></a>
<a class="sourceLine" id="cb17-42" title="42"><span class="co">#&gt; wt           .        </span></a>
<a class="sourceLine" id="cb17-43" title="43"><span class="co">#&gt; qsec        -4.7106332</span></a>
<a class="sourceLine" id="cb17-44" title="44"><span class="co">#&gt; vs           .        </span></a>
<a class="sourceLine" id="cb17-45" title="45"><span class="co">#&gt; am           .        </span></a>
<a class="sourceLine" id="cb17-46" title="46"><span class="co">#&gt; gear        14.3668406</span></a>
<a class="sourceLine" id="cb17-47" title="47"><span class="co">#&gt; carb        15.9986389</span></a></code></pre></div>
<ul>
<li>Combine all coefficients in a table:</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">a_boot <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="st"> </span><span class="kw">map</span>(<span class="st">"fit"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="st"> </span><span class="kw">map</span>(broom<span class="op">::</span>tidy) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="st"> </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">select</span>(.x, term, estimate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="st"> </span><span class="kw">map2</span>(<span class="dt">.y =</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(.), <span class="op">~</span><span class="st"> </span><span class="kw">rename_at</span>(.x, <span class="kw">vars</span>(estimate), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(., <span class="st">"_"</span>, .y)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="st"> </span><span class="kw">reduce</span>(full_join, <span class="dt">by =</span> <span class="st">"term"</span>)</a>
<a class="sourceLine" id="cb18-7" title="7"><span class="co">#&gt; # A tibble: 9 x 4</span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="co">#&gt;   term        estimate_1 estimate_2 estimate_3</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb18-10" title="10"><span class="co">#&gt; 1 (Intercept)    308.       289.        24.2  </span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co">#&gt; 2 mpg             -1.40      NA         NA    </span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="co">#&gt; 3 cyl              7.94       1.37       5.69 </span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="co">#&gt; 4 disp             0.200      0.252      0.309</span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="co">#&gt; 5 qsec           -13.7      -12.3       -4.71 </span></a>
<a class="sourceLine" id="cb18-15" title="15"><span class="co">#&gt; 6 vs              12.4       NA         NA    </span></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="co">#&gt; 7 carb             1.99       4.80      16.0  </span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="co">#&gt; 8 am              NA        -11.9       NA    </span></a>
<a class="sourceLine" id="cb18-18" title="18"><span class="co">#&gt; 9 gear            NA         NA         14.4</span></a></code></pre></div>
<p>The source code of the function looks like:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">estimate_matches</a>
<a class="sourceLine" id="cb19-2" title="2"><span class="co">#&gt; function (source_x_mat, source_y_mat, source_w_mat, target_x_mat, </span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co">#&gt;     n_near = 5, n_folds = 10, force_lambda = NULL, reduced = TRUE) </span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="co">#&gt;     if (is.null(force_lambda) || is.na(force_lambda)) {</span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="co">#&gt;         lambda_cv &lt;- glmnet::cv.glmnet(x = source_x_mat, y = source_y_mat, </span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co">#&gt;             weights = source_w_mat, type.measure = "mse", nfolds = n_folds)</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="co">#&gt;     else {</span></a>
<a class="sourceLine" id="cb19-10" title="10"><span class="co">#&gt;         lambda_cv &lt;- list()</span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="co">#&gt;         lambda_cv$lambda.min &lt;- force_lambda</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb19-13" title="13"><span class="co">#&gt;     fit &lt;- glmnet::glmnet(x = source_x_mat, y = source_y_mat, </span></a>
<a class="sourceLine" id="cb19-14" title="14"><span class="co">#&gt;         weights = source_w_mat, alpha = 1, lambda = lambda_cv$lambda.min)</span></a>
<a class="sourceLine" id="cb19-15" title="15"><span class="co">#&gt;     source_y_hat &lt;- stats::predict(fit, newx = source_x_mat)[, </span></a>
<a class="sourceLine" id="cb19-16" title="16"><span class="co">#&gt;         1]</span></a>
<a class="sourceLine" id="cb19-17" title="17"><span class="co">#&gt;     target_y_hat &lt;- stats::predict(fit, newx = target_x_mat)[, </span></a>
<a class="sourceLine" id="cb19-18" title="18"><span class="co">#&gt;         1]</span></a>
<a class="sourceLine" id="cb19-19" title="19"><span class="co">#&gt;     match &lt;- find_near(target_y_hat, source_y_hat, n_near)</span></a>
<a class="sourceLine" id="cb19-20" title="20"><span class="co">#&gt;     if (!reduced) {</span></a>
<a class="sourceLine" id="cb19-21" title="21"><span class="co">#&gt;         return(list(source_x_mat = source_x_mat, source_w_mat = source_w_mat, </span></a>
<a class="sourceLine" id="cb19-22" title="22"><span class="co">#&gt;             source_y_mat = source_y_mat, target_x_mat = target_x_mat, </span></a>
<a class="sourceLine" id="cb19-23" title="23"><span class="co">#&gt;             lambda_cv = lambda_cv, fit = fit, source_y_hat = source_y_hat, </span></a>
<a class="sourceLine" id="cb19-24" title="24"><span class="co">#&gt;             target_y_hat = target_y_hat, match = match))</span></a>
<a class="sourceLine" id="cb19-25" title="25"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb19-26" title="26"><span class="co">#&gt;     else {</span></a>
<a class="sourceLine" id="cb19-27" title="27"><span class="co">#&gt;         return(list(source_y_hat = source_y_hat, target_y_hat = target_y_hat, </span></a>
<a class="sourceLine" id="cb19-28" title="28"><span class="co">#&gt;             match = match))</span></a>
<a class="sourceLine" id="cb19-29" title="29"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb19-30" title="30"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb19-31" title="31"><span class="co">#&gt; &lt;bytecode: 0x0000000014ffc7f0&gt;</span></a>
<a class="sourceLine" id="cb19-32" title="32"><span class="co">#&gt; &lt;environment: namespace:lassopmm&gt;</span></a></code></pre></div>
</div>
<div id="step-3--wrap-up-around-input-as-data-frames-and-multiple-imputations-data-as-an-output-" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3--wrap-up-around-input-as-data-frames-and-multiple-imputations-data-as-an-output-" class="anchor"></a>Step 3. Wrap up around input as data frames and multiple imputations data as an output.</h2>
<p>As a wrap-up example, we use the read me example. It is a straight forward initialization of built-in package data and running the analysis.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">glimpse</span>(p_<span class="dv">0</span>_exmple)       <span class="co"># help(p_0_exmple)</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co">#&gt; Observations: 74</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co">#&gt; Variables: 16</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="co">#&gt; $ make         &lt;chr&gt; "AMC Concord", "AMC Pacer", "AMC Spirit", "Buick ...</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="co">#&gt; $ price        &lt;dbl&gt; 4099, 4749, 3799, 4816, 7827, 5788, 4453, 5189, 1...</span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="co">#&gt; $ mpg          &lt;dbl&gt; 22, 17, 22, 20, 15, 18, 26, 20, 16, 19, 14, 14, 2...</span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="co">#&gt; $ rep78        &lt;dbl&gt; 3, 3, NA, 3, 4, 3, NA, 3, 3, 3, 3, 2, 3, 3, 4, 3,...</span></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="co">#&gt; $ headroom     &lt;dbl&gt; 2.5, 3.0, 3.0, 4.5, 4.0, 4.0, 3.0, 2.0, 3.5, 3.5,...</span></a>
<a class="sourceLine" id="cb20-9" title="9"><span class="co">#&gt; $ trunk        &lt;dbl&gt; 11, 11, 12, 16, 20, 21, 10, 16, 17, 13, 20, 16, 1...</span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="co">#&gt; $ weight       &lt;dbl&gt; 2930, 3350, 2640, 3250, 4080, 3670, 2230, 3280, 3...</span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="co">#&gt; $ length       &lt;dbl&gt; 186, 173, 168, 196, 222, 218, 170, 200, 207, 200,...</span></a>
<a class="sourceLine" id="cb20-12" title="12"><span class="co">#&gt; $ turn         &lt;dbl&gt; 40, 40, 35, 40, 43, 43, 34, 42, 43, 42, 44, 43, 4...</span></a>
<a class="sourceLine" id="cb20-13" title="13"><span class="co">#&gt; $ displacement &lt;dbl&gt; 121, 258, 121, 196, 350, 231, 304, 196, 231, 231,...</span></a>
<a class="sourceLine" id="cb20-14" title="14"><span class="co">#&gt; $ gear_ratio   &lt;dbl&gt; 3.58, 2.53, 3.08, 2.93, 2.41, 2.73, 2.87, 2.93, 2...</span></a>
<a class="sourceLine" id="cb20-15" title="15"><span class="co">#&gt; $ foreign      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0...</span></a>
<a class="sourceLine" id="cb20-16" title="16"><span class="co">#&gt; $ psu          &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2...</span></a>
<a class="sourceLine" id="cb20-17" title="17"><span class="co">#&gt; $ numobs       &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15...</span></a>
<a class="sourceLine" id="cb20-18" title="18"><span class="co">#&gt; $ samples      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0...</span></a>
<a class="sourceLine" id="cb20-19" title="19"><span class="co">#&gt; $ numobs11     &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15...</span></a>
<a class="sourceLine" id="cb20-20" title="20"><span class="kw">glimpse</span>(p_<span class="dv">1</span>_exmple)       <span class="co"># help(p_1_exmple)</span></a>
<a class="sourceLine" id="cb20-21" title="21"><span class="co">#&gt; Observations: 7</span></a>
<a class="sourceLine" id="cb20-22" title="22"><span class="co">#&gt; Variables: 16</span></a>
<a class="sourceLine" id="cb20-23" title="23"><span class="co">#&gt; $ make         &lt;chr&gt; "Renault Le Car", "VW Diesel", "Merc. Monarch", "...</span></a>
<a class="sourceLine" id="cb20-24" title="24"><span class="co">#&gt; $ price        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA</span></a>
<a class="sourceLine" id="cb20-25" title="25"><span class="co">#&gt; $ mpg          &lt;dbl&gt; 26, 41, 18, 28, 19, 17, 12</span></a>
<a class="sourceLine" id="cb20-26" title="26"><span class="co">#&gt; $ rep78        &lt;dbl&gt; 3, 5, 3, 4, 3, 2, 3</span></a>
<a class="sourceLine" id="cb20-27" title="27"><span class="co">#&gt; $ headroom     &lt;dbl&gt; 3.0, 3.0, 3.0, 1.5, 2.0, 4.5, 2.5</span></a>
<a class="sourceLine" id="cb20-28" title="28"><span class="co">#&gt; $ trunk        &lt;dbl&gt; 10, 15, 15, 9, 16, 21, 18</span></a>
<a class="sourceLine" id="cb20-29" title="29"><span class="co">#&gt; $ weight       &lt;dbl&gt; 1830, 2040, 3370, 1800, 3210, 3740, 4720</span></a>
<a class="sourceLine" id="cb20-30" title="30"><span class="co">#&gt; $ length       &lt;dbl&gt; 142, 155, 198, 147, 201, 220, 230</span></a>
<a class="sourceLine" id="cb20-31" title="31"><span class="co">#&gt; $ turn         &lt;dbl&gt; 34, 35, 41, 33, 45, 46, 48</span></a>
<a class="sourceLine" id="cb20-32" title="32"><span class="co">#&gt; $ displacement &lt;dbl&gt; 79, 90, 250, 98, 231, 225, 400</span></a>
<a class="sourceLine" id="cb20-33" title="33"><span class="co">#&gt; $ gear_ratio   &lt;dbl&gt; 3.72, 3.78, 2.43, 3.15, 2.93, 2.94, 2.47</span></a>
<a class="sourceLine" id="cb20-34" title="34"><span class="co">#&gt; $ foreign      &lt;dbl&gt; 1, 1, 0, 0, 0, 0, 0</span></a>
<a class="sourceLine" id="cb20-35" title="35"><span class="co">#&gt; $ psu          &lt;dbl&gt; 7, 7, 4, 3, 5, 3, 3</span></a>
<a class="sourceLine" id="cb20-36" title="36"><span class="co">#&gt; $ numobs       &lt;dbl&gt; 65, 71, 32, 24, 49, 23, 27</span></a>
<a class="sourceLine" id="cb20-37" title="37"><span class="co">#&gt; $ samples      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1</span></a>
<a class="sourceLine" id="cb20-38" title="38"><span class="co">#&gt; $ numobs11     &lt;dbl&gt; 75, 76, 77, 78, 79, 80, 81</span></a>
<a class="sourceLine" id="cb20-39" title="39"><span class="kw">glimpse</span>(sample_bootstrap) <span class="co"># help(sample_bootstrap)</span></a>
<a class="sourceLine" id="cb20-40" title="40"><span class="co">#&gt; Observations: 73</span></a>
<a class="sourceLine" id="cb20-41" title="41"><span class="co">#&gt; Variables: 5</span></a>
<a class="sourceLine" id="cb20-42" title="42"><span class="co">#&gt; $ ...1 &lt;dbl&gt; 1, 8, 4, 6, 5, 9, 4, 3, 2, 15, 17, 12, 10, 12, 13, 16, 19...</span></a>
<a class="sourceLine" id="cb20-43" title="43"><span class="co">#&gt; $ ...2 &lt;dbl&gt; 1, 2, 7, 4, 3, 9, 6, 6, 9, 10, 16, 19, 19, 16, 10, 16, 16...</span></a>
<a class="sourceLine" id="cb20-44" title="44"><span class="co">#&gt; $ ...3 &lt;dbl&gt; 7, 6, 9, 2, 1, 9, 4, 3, 4, 10, 11, 14, 16, 16, 10, 13, 10...</span></a>
<a class="sourceLine" id="cb20-45" title="45"><span class="co">#&gt; $ ...4 &lt;dbl&gt; 8, 4, 6, 3, 5, 4, 5, 1, 2, 18, 10, 18, 12, 19, 12, 15, 10...</span></a>
<a class="sourceLine" id="cb20-46" title="46"><span class="co">#&gt; $ ...5 &lt;dbl&gt; 8, 5, 4, 3, 1, 8, 3, 2, 3, 12, 10, 12, 17, 16, 15, 11, 13...</span></a>
<a class="sourceLine" id="cb20-47" title="47"></a>
<a class="sourceLine" id="cb20-48" title="48">dep &lt;-<span class="st"> "price"</span>            <span class="co"># Dependent variable</span></a>
<a class="sourceLine" id="cb20-49" title="49">indep &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mpg"</span>, <span class="st">"headroom"</span>, <span class="st">"trunk"</span>,</a>
<a class="sourceLine" id="cb20-50" title="50">           <span class="st">"weight"</span>, <span class="st">"length"</span>, <span class="st">"turn"</span>,</a>
<a class="sourceLine" id="cb20-51" title="51">           <span class="st">"displacement"</span>, <span class="st">"gear_ratio"</span>,</a>
<a class="sourceLine" id="cb20-52" title="52">           <span class="st">"foreign"</span>)     <span class="co"># independent variables</span></a>
<a class="sourceLine" id="cb20-53" title="53">weight &lt;-<span class="st"> "weight"</span>        <span class="co"># weight variable</span></a>
<a class="sourceLine" id="cb20-54" title="54">extrar &lt;-<span class="st"> "displacement"</span>  <span class="co"># any extra variable to bring from period 0 data</span></a>
<a class="sourceLine" id="cb20-55" title="55">bt_groups &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"psu"</span>)     <span class="co"># Grouping variable for bootsrapping.</span></a>
<a class="sourceLine" id="cb20-56" title="56">                          <span class="co"># May be a combination of variables.</span></a>
<a class="sourceLine" id="cb20-57" title="57">n_nearest &lt;-<span class="st"> </span><span class="dv">1</span>    <span class="co"># numebr of the nearest observations to drow a random match</span></a>
<a class="sourceLine" id="cb20-58" title="58"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">11223344</span>)</a>
<a class="sourceLine" id="cb20-59" title="59">imputation &lt;-</a>
<a class="sourceLine" id="cb20-60" title="60"><span class="st">  </span><span class="kw"><a href="../reference/lassopmm.html">lassopmm</a></span>(</a>
<a class="sourceLine" id="cb20-61" title="61">    <span class="dt">source =</span> p_<span class="dv">0</span>_exmple, </a>
<a class="sourceLine" id="cb20-62" title="62">    <span class="dt">target =</span> p_<span class="dv">1</span>_exmple,</a>
<a class="sourceLine" id="cb20-63" title="63">    <span class="dt">dep_var =</span> dep, </a>
<a class="sourceLine" id="cb20-64" title="64">    <span class="dt">indep_var =</span> indep, </a>
<a class="sourceLine" id="cb20-65" title="65">    <span class="dt">weight_var =</span> weight,</a>
<a class="sourceLine" id="cb20-66" title="66">    <span class="dt">strata_vars =</span> bt_groups,</a>
<a class="sourceLine" id="cb20-67" title="67">    <span class="dt">extra_var =</span> extrar,</a>
<a class="sourceLine" id="cb20-68" title="68">    <span class="dt">n_boot =</span> <span class="dv">5</span>, <span class="co"># Numebr of bootstrap iterations</span></a>
<a class="sourceLine" id="cb20-69" title="69">    <span class="dt">n_near =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-70" title="70"></a>
<a class="sourceLine" id="cb20-71" title="71"><span class="kw">glimpse</span>(imputation)</a>
<a class="sourceLine" id="cb20-72" title="72"><span class="co">#&gt; Observations: 42</span></a>
<a class="sourceLine" id="cb20-73" title="73"><span class="co">#&gt; Variables: 23</span></a>
<a class="sourceLine" id="cb20-74" title="74"><span class="co">#&gt; $ .imp                &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, ...</span></a>
<a class="sourceLine" id="cb20-75" title="75"><span class="co">#&gt; $ .id                 &lt;chr&gt; "1", "2", "3", "4", "5", "6", "7", "1", "2...</span></a>
<a class="sourceLine" id="cb20-76" title="76"><span class="co">#&gt; $ make                &lt;chr&gt; "Renault Le Car", "VW Diesel", "Merc. Mona...</span></a>
<a class="sourceLine" id="cb20-77" title="77"><span class="co">#&gt; $ price               &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...</span></a>
<a class="sourceLine" id="cb20-78" title="78"><span class="co">#&gt; $ mpg                 &lt;dbl&gt; 26, 41, 18, 28, 19, 17, 12, 26, 41, 18, 28...</span></a>
<a class="sourceLine" id="cb20-79" title="79"><span class="co">#&gt; $ rep78               &lt;dbl&gt; 3, 5, 3, 4, 3, 2, 3, 3, 5, 3, 4, 3, 2, 3, ...</span></a>
<a class="sourceLine" id="cb20-80" title="80"><span class="co">#&gt; $ headroom            &lt;dbl&gt; 3.0, 3.0, 3.0, 1.5, 2.0, 4.5, 2.5, 3.0, 3....</span></a>
<a class="sourceLine" id="cb20-81" title="81"><span class="co">#&gt; $ trunk               &lt;dbl&gt; 10, 15, 15, 9, 16, 21, 18, 10, 15, 15, 9, ...</span></a>
<a class="sourceLine" id="cb20-82" title="82"><span class="co">#&gt; $ weight              &lt;dbl&gt; 1830, 2040, 3370, 1800, 3210, 3740, 4720, ...</span></a>
<a class="sourceLine" id="cb20-83" title="83"><span class="co">#&gt; $ length              &lt;dbl&gt; 142, 155, 198, 147, 201, 220, 230, 142, 15...</span></a>
<a class="sourceLine" id="cb20-84" title="84"><span class="co">#&gt; $ turn                &lt;dbl&gt; 34, 35, 41, 33, 45, 46, 48, 34, 35, 41, 33...</span></a>
<a class="sourceLine" id="cb20-85" title="85"><span class="co">#&gt; $ displacement        &lt;dbl&gt; 79, 90, 250, 98, 231, 225, 400, 79, 90, 25...</span></a>
<a class="sourceLine" id="cb20-86" title="86"><span class="co">#&gt; $ gear_ratio          &lt;dbl&gt; 3.72, 3.78, 2.43, 3.15, 2.93, 2.94, 2.47, ...</span></a>
<a class="sourceLine" id="cb20-87" title="87"><span class="co">#&gt; $ foreign             &lt;dbl&gt; 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, ...</span></a>
<a class="sourceLine" id="cb20-88" title="88"><span class="co">#&gt; $ psu                 &lt;dbl&gt; 7, 7, 4, 3, 5, 3, 3, 7, 7, 4, 3, 5, 3, 3, ...</span></a>
<a class="sourceLine" id="cb20-89" title="89"><span class="co">#&gt; $ numobs              &lt;dbl&gt; 65, 71, 32, 24, 49, 23, 27, 65, 71, 32, 24...</span></a>
<a class="sourceLine" id="cb20-90" title="90"><span class="co">#&gt; $ samples             &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...</span></a>
<a class="sourceLine" id="cb20-91" title="91"><span class="co">#&gt; $ numobs11            &lt;dbl&gt; 75, 76, 77, 78, 79, 80, 81, 75, 76, 77, 78...</span></a>
<a class="sourceLine" id="cb20-92" title="92"><span class="co">#&gt; $ target_y_hat        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 5900.663, 4759...</span></a>
<a class="sourceLine" id="cb20-93" title="93"><span class="co">#&gt; $ source_id           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, "65", "71", "1...</span></a>
<a class="sourceLine" id="cb20-94" title="94"><span class="co">#&gt; $ source_y_hat        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 5900.663, 4759...</span></a>
<a class="sourceLine" id="cb20-95" title="95"><span class="co">#&gt; $ price_source        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 3895, 5397, 45...</span></a>
<a class="sourceLine" id="cb20-96" title="96"><span class="co">#&gt; $ displacement_source &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, 79, 90, 200, 9...</span></a>
<a class="sourceLine" id="cb20-97" title="97"></a>
<a class="sourceLine" id="cb20-98" title="98"><span class="co"># Summary of the number of observations per one ID</span></a>
<a class="sourceLine" id="cb20-99" title="99"><span class="co"># 6 in total meaning that 1 observation stands for original</span></a>
<a class="sourceLine" id="cb20-100" title="100"><span class="co"># non imputed data and others are bootstrap imputations</span></a>
<a class="sourceLine" id="cb20-101" title="101">imputation <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(.id) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb20-102" title="102"><span class="co">#&gt; # A tibble: 7 x 2</span></a>
<a class="sourceLine" id="cb20-103" title="103"><span class="co">#&gt; # Groups:   .id [7]</span></a>
<a class="sourceLine" id="cb20-104" title="104"><span class="co">#&gt;   .id       n</span></a>
<a class="sourceLine" id="cb20-105" title="105"><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb20-106" title="106"><span class="co">#&gt; 1 1         6</span></a>
<a class="sourceLine" id="cb20-107" title="107"><span class="co">#&gt; 2 2         6</span></a>
<a class="sourceLine" id="cb20-108" title="108"><span class="co">#&gt; 3 3         6</span></a>
<a class="sourceLine" id="cb20-109" title="109"><span class="co">#&gt; 4 4         6</span></a>
<a class="sourceLine" id="cb20-110" title="110"><span class="co">#&gt; 5 5         6</span></a>
<a class="sourceLine" id="cb20-111" title="111"><span class="co">#&gt; 6 6         6</span></a>
<a class="sourceLine" id="cb20-112" title="112"><span class="co">#&gt; 7 7         6</span></a>
<a class="sourceLine" id="cb20-113" title="113"></a>
<a class="sourceLine" id="cb20-114" title="114"><span class="co"># Summary of the number of observations per imputation. 7 - consisten</span></a>
<a class="sourceLine" id="cb20-115" title="115"><span class="co"># 0 imputation is the original data.</span></a>
<a class="sourceLine" id="cb20-116" title="116">imputation <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(.imp) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb20-117" title="117"><span class="co">#&gt; # A tibble: 6 x 2</span></a>
<a class="sourceLine" id="cb20-118" title="118"><span class="co">#&gt; # Groups:   .imp [6]</span></a>
<a class="sourceLine" id="cb20-119" title="119"><span class="co">#&gt;    .imp     n</span></a>
<a class="sourceLine" id="cb20-120" title="120"><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb20-121" title="121"><span class="co">#&gt; 1     0     7</span></a>
<a class="sourceLine" id="cb20-122" title="122"><span class="co">#&gt; 2     1     7</span></a>
<a class="sourceLine" id="cb20-123" title="123"><span class="co">#&gt; 3     2     7</span></a>
<a class="sourceLine" id="cb20-124" title="124"><span class="co">#&gt; 4     3     7</span></a>
<a class="sourceLine" id="cb20-125" title="125"><span class="co">#&gt; 5     4     7</span></a>
<a class="sourceLine" id="cb20-126" title="126"><span class="co">#&gt; 6     5     7</span></a></code></pre></div>
<p>Source code of the function is:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">lassopmm</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">#&gt; function (source, target, dep_var, indep_var, weight_var = NULL, </span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="co">#&gt;     extra_var = NULL, strata_vars = NULL, cluster_vars = NULL, </span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="co">#&gt;     n_near = 10, n_boot = 5, force_boot = NULL, force_lambda = NULL, </span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co">#&gt;     n_folds = 10, reduced = TRUE, updateProgress = NULL) </span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">#&gt;     y_mat &lt;- source %&gt;% dplyr::select(dep_var) %&gt;% as.matrix()</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co">#&gt;     x_mat &lt;- source %&gt;% dplyr::select(indep_var) %&gt;% as.matrix()</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co">#&gt;     x1_mat &lt;- target %&gt;% dplyr::select(indep_var) %&gt;% as.matrix()</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="co">#&gt;     rownames(y_mat) &lt;- 1:nrow(y_mat)</span></a>
<a class="sourceLine" id="cb21-11" title="11"><span class="co">#&gt;     rownames(x_mat) &lt;- 1:nrow(x_mat)</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="co">#&gt;     rownames(x1_mat) &lt;- 1:nrow(x1_mat)</span></a>
<a class="sourceLine" id="cb21-13" title="13"><span class="co">#&gt;     vars_to_bring &lt;- names(source)[names(source) %in% c(dep_var, </span></a>
<a class="sourceLine" id="cb21-14" title="14"><span class="co">#&gt;         extra_var)]</span></a>
<a class="sourceLine" id="cb21-15" title="15"><span class="co">#&gt;     if (is.na(weight_var) || is.null(weight_var)) {</span></a>
<a class="sourceLine" id="cb21-16" title="16"><span class="co">#&gt;         message("Default weights equal to all observations are used.")</span></a>
<a class="sourceLine" id="cb21-17" title="17"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-18" title="18"><span class="co">#&gt;     else if (!weight_var %in% names(source)) {</span></a>
<a class="sourceLine" id="cb21-19" title="19"><span class="co">#&gt;         warning(paste0("Weight variable '", weight_var, "' does not exist in the data.\n", </span></a>
<a class="sourceLine" id="cb21-20" title="20"><span class="co">#&gt;             "Default weights equal to all observations are used instead."))</span></a>
<a class="sourceLine" id="cb21-21" title="21"><span class="co">#&gt;         w_mat &lt;- matrix(rep(1, nrow(source)), nrow = nrow(source), </span></a>
<a class="sourceLine" id="cb21-22" title="22"><span class="co">#&gt;             ncol = 1)</span></a>
<a class="sourceLine" id="cb21-23" title="23"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-24" title="24"><span class="co">#&gt;     else {</span></a>
<a class="sourceLine" id="cb21-25" title="25"><span class="co">#&gt;         w_mat &lt;- source %&gt;% dplyr::select(weight_var) %&gt;% as.matrix()</span></a>
<a class="sourceLine" id="cb21-26" title="26"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-27" title="27"><span class="co">#&gt;     rownames(w_mat) &lt;- 1:nrow(w_mat)</span></a>
<a class="sourceLine" id="cb21-28" title="28"><span class="co">#&gt;     if (any(!strata_vars %in% names(source)) &amp;&amp; !all(!strata_vars %in% </span></a>
<a class="sourceLine" id="cb21-29" title="29"><span class="co">#&gt;         names(source)) &amp;&amp; !is.null(strata_vars) &amp;&amp; !is.na(strata_vars)) {</span></a>
<a class="sourceLine" id="cb21-30" title="30"><span class="co">#&gt;         warning(paste0("Variable(s) '", paste0(strata_vars[!strata_vars %in% </span></a>
<a class="sourceLine" id="cb21-31" title="31"><span class="co">#&gt;             names(source)], collapse = "', '"), "' do not exist in the `source` data.\n", </span></a>
<a class="sourceLine" id="cb21-32" title="32"><span class="co">#&gt;             "Only variable(s) '", paste0(strata_vars[strata_vars %in% </span></a>
<a class="sourceLine" id="cb21-33" title="33"><span class="co">#&gt;                 names(source)], collapse = "', '"), "' will be used for creating stratified bootstrap permulation vectors."))</span></a>
<a class="sourceLine" id="cb21-34" title="34"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-35" title="35"><span class="co">#&gt;     else if (all(!strata_vars %in% names(source)) &amp;&amp; !is.null(strata_vars) &amp;&amp; </span></a>
<a class="sourceLine" id="cb21-36" title="36"><span class="co">#&gt;         !is.na(strata_vars)) {</span></a>
<a class="sourceLine" id="cb21-37" title="37"><span class="co">#&gt;         warning(paste0("Variable(s) '", paste0(strata_vars[!strata_vars %in% </span></a>
<a class="sourceLine" id="cb21-38" title="38"><span class="co">#&gt;             names(source)], collapse = "', '"), "' do not exist in the `source` data.\n", </span></a>
<a class="sourceLine" id="cb21-39" title="39"><span class="co">#&gt;             "No grouped bootstrap permulation is applied."))</span></a>
<a class="sourceLine" id="cb21-40" title="40"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-41" title="41"><span class="co">#&gt;     if (any(!cluster_vars %in% names(source)) &amp;&amp; !all(!cluster_vars %in% </span></a>
<a class="sourceLine" id="cb21-42" title="42"><span class="co">#&gt;         names(source)) &amp;&amp; !is.null(cluster_vars) &amp;&amp; !is.na(cluster_vars)) {</span></a>
<a class="sourceLine" id="cb21-43" title="43"><span class="co">#&gt;         warning(paste0("Variable(s) '", paste0(cluster_vars[!cluster_vars %in% </span></a>
<a class="sourceLine" id="cb21-44" title="44"><span class="co">#&gt;             names(source)], collapse = "', '"), "' do not exist in the `source` data.\n", </span></a>
<a class="sourceLine" id="cb21-45" title="45"><span class="co">#&gt;             "Only variable(s) '", paste0(cluster_vars[cluster_vars %in% </span></a>
<a class="sourceLine" id="cb21-46" title="46"><span class="co">#&gt;                 names(source)], collapse = "', '"), "' will be used for creating clusters in the bootstrap permulation vectors."))</span></a>
<a class="sourceLine" id="cb21-47" title="47"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-48" title="48"><span class="co">#&gt;     else if (all(!cluster_vars %in% names(source)) &amp;&amp; !is.null(cluster_vars) &amp;&amp; </span></a>
<a class="sourceLine" id="cb21-49" title="49"><span class="co">#&gt;         !is.na(cluster_vars)) {</span></a>
<a class="sourceLine" id="cb21-50" title="50"><span class="co">#&gt;         warning(paste0("Variable(s) '", paste0(cluster_vars[!cluster_vars %in% </span></a>
<a class="sourceLine" id="cb21-51" title="51"><span class="co">#&gt;             names(source)], collapse = "', '"), "' do not exist in the `source` data.\n", </span></a>
<a class="sourceLine" id="cb21-52" title="52"><span class="co">#&gt;             "No grouped bootstrap permulation is applied."))</span></a>
<a class="sourceLine" id="cb21-53" title="53"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-54" title="54"><span class="co">#&gt;     group_mat &lt;- source %&gt;% dplyr::mutate(ids = row_number(), </span></a>
<a class="sourceLine" id="cb21-55" title="55"><span class="co">#&gt;         .strata = 1, .cluster = 1)</span></a>
<a class="sourceLine" id="cb21-56" title="56"><span class="co">#&gt;     if (any(strata_vars %in% names(source))) {</span></a>
<a class="sourceLine" id="cb21-57" title="57"><span class="co">#&gt;         group_mat &lt;- group_mat %&gt;% dplyr::group_by_at(vars(strata_vars[strata_vars %in% </span></a>
<a class="sourceLine" id="cb21-58" title="58"><span class="co">#&gt;             names(source)])) %&gt;% dplyr::mutate(.strata = dplyr::group_indices()) %&gt;% </span></a>
<a class="sourceLine" id="cb21-59" title="59"><span class="co">#&gt;             dplyr::ungroup()</span></a>
<a class="sourceLine" id="cb21-60" title="60"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-61" title="61"><span class="co">#&gt;     if (any(cluster_vars %in% names(source))) {</span></a>
<a class="sourceLine" id="cb21-62" title="62"><span class="co">#&gt;         group_mat &lt;- group_mat %&gt;% dplyr::group_by_at(vars(cluster_vars[cluster_vars %in% </span></a>
<a class="sourceLine" id="cb21-63" title="63"><span class="co">#&gt;             names(source)])) %&gt;% dplyr::mutate(.cluster = group_indices()) %&gt;% </span></a>
<a class="sourceLine" id="cb21-64" title="64"><span class="co">#&gt;             dplyr::ungroup()</span></a>
<a class="sourceLine" id="cb21-65" title="65"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-66" title="66"><span class="co">#&gt;     group_mat &lt;- group_mat %&gt;% dplyr::select(ids, .strata, .cluster)</span></a>
<a class="sourceLine" id="cb21-67" title="67"><span class="co">#&gt;     if (is.null(force_boot)) {</span></a>
<a class="sourceLine" id="cb21-68" title="68"><span class="co">#&gt;         boot_perm_vector &lt;- get_bootstrap_permutation(group_mat, </span></a>
<a class="sourceLine" id="cb21-69" title="69"><span class="co">#&gt;             n_boot)</span></a>
<a class="sourceLine" id="cb21-70" title="70"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-71" title="71"><span class="co">#&gt;     else {</span></a>
<a class="sourceLine" id="cb21-72" title="72"><span class="co">#&gt;         boot_perm_vector &lt;- convert_bootstrap_permutation(force_boot)</span></a>
<a class="sourceLine" id="cb21-73" title="73"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-74" title="74"><span class="co">#&gt;     if (is.null(updateProgress)) {</span></a>
<a class="sourceLine" id="cb21-75" title="75"><span class="co">#&gt;         updateProgress &lt;- function(detail = NULL) return(NULL)</span></a>
<a class="sourceLine" id="cb21-76" title="76"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-77" title="77"><span class="co">#&gt;     all_boots &lt;- boot_perm_vector %&gt;% purrr::map2(.x = ., .y = seq_along(.), </span></a>
<a class="sourceLine" id="cb21-78" title="78"><span class="co">#&gt;         .f = function(.x, .y) {</span></a>
<a class="sourceLine" id="cb21-79" title="79"><span class="co">#&gt;             updateProgress(detail = paste0("Bootstrap iteration ", </span></a>
<a class="sourceLine" id="cb21-80" title="80"><span class="co">#&gt;                 .y, "."))</span></a>
<a class="sourceLine" id="cb21-81" title="81"><span class="co">#&gt;             estimate_matches(source_x_mat = x_mat[.x, ], source_y_mat = y_mat[.x, </span></a>
<a class="sourceLine" id="cb21-82" title="82"><span class="co">#&gt;                 ], source_w_mat = w_mat[.x, ], target_x_mat = x1_mat, </span></a>
<a class="sourceLine" id="cb21-83" title="83"><span class="co">#&gt;                 reduced = reduced, n_near = n_near, n_folds = n_folds, </span></a>
<a class="sourceLine" id="cb21-84" title="84"><span class="co">#&gt;                 force_lambda = force_lambda)</span></a>
<a class="sourceLine" id="cb21-85" title="85"><span class="co">#&gt;         })</span></a>
<a class="sourceLine" id="cb21-86" title="86"><span class="co">#&gt;     updateProgress(detail = "Matching observations")</span></a>
<a class="sourceLine" id="cb21-87" title="87"><span class="co">#&gt;     all_matches &lt;- all_boots %&gt;% purrr::map("match") %&gt;% tibble::enframe(".imp") %&gt;% </span></a>
<a class="sourceLine" id="cb21-88" title="88"><span class="co">#&gt;         tidyr::unnest() %&gt;% dplyr::left_join(source %&gt;% dplyr::mutate(source_id = as.character(row_number())) %&gt;% </span></a>
<a class="sourceLine" id="cb21-89" title="89"><span class="co">#&gt;         dplyr::select(source_id, vars_to_bring) %&gt;% dplyr::rename_at(dplyr::vars(vars_to_bring), </span></a>
<a class="sourceLine" id="cb21-90" title="90"><span class="co">#&gt;         list(~paste0(., "_source"))), by = "source_id")</span></a>
<a class="sourceLine" id="cb21-91" title="91"><span class="co">#&gt;     target_matches &lt;- target %&gt;% dplyr::mutate(target_id = as.character(row_number()), </span></a>
<a class="sourceLine" id="cb21-92" title="92"><span class="co">#&gt;         .imp = 0L) %&gt;% dplyr::bind_rows(dplyr::right_join((.) %&gt;% </span></a>
<a class="sourceLine" id="cb21-93" title="93"><span class="co">#&gt;         dplyr::select(-.imp), all_matches, by = "target_id")) %&gt;% </span></a>
<a class="sourceLine" id="cb21-94" title="94"><span class="co">#&gt;         dplyr::rename(.id = target_id) %&gt;% dplyr::select(.imp, </span></a>
<a class="sourceLine" id="cb21-95" title="95"><span class="co">#&gt;         .id, tidyselect::everything())</span></a>
<a class="sourceLine" id="cb21-96" title="96"><span class="co">#&gt;     if (reduced) {</span></a>
<a class="sourceLine" id="cb21-97" title="97"><span class="co">#&gt;         return(target_matches)</span></a>
<a class="sourceLine" id="cb21-98" title="98"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-99" title="99"><span class="co">#&gt;     else {</span></a>
<a class="sourceLine" id="cb21-100" title="100"><span class="co">#&gt;         list(all_boots = all_boots, target_matches = target_matches) %&gt;% </span></a>
<a class="sourceLine" id="cb21-101" title="101"><span class="co">#&gt;             return()</span></a>
<a class="sourceLine" id="cb21-102" title="102"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb21-103" title="103"><span class="co">#&gt; }</span></a>
<a class="sourceLine" id="cb21-104" title="104"><span class="co">#&gt; &lt;bytecode: 0x0000000019bd5660&gt;</span></a>
<a class="sourceLine" id="cb21-105" title="105"><span class="co">#&gt; &lt;environment: namespace:lassopmm&gt;</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#step-1--bootstrapping">Step 1. Bootstrapping</a></li>
      <li><a href="#step-2--matching-the-nearest-observation">Step 2. Matching the nearest observation</a></li>
      <li><a href="#step-3--estimating-matches">Step 3. Estimating matches</a></li>
      <li><a href="#step-3--wrap-up-around-input-as-data-frames-and-multiple-imputations-data-as-an-output-">Step 3. Wrap up around input as data frames and multiple imputations data as an output.</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Leonardo Lucchetti, Paul Corral, Eduard Bukin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
